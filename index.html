<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador Mundial 2026</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;500;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-deep: #0f172a;
            --accent-gold: #fbbf24;
            --accent-silver: #94a3b8;
            --accent-bronze: #cd7f32;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: radial-gradient(circle at top, #1e293b, #020617);
            color: white;
            overflow-x: hidden; /* Para evitar scroll global horizontal, usamos scroll interno en el bracket */
        }

        /* --- Estilos Generales --- */
        .glass-panel {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .team-card {
            transition: all 0.2s;
            cursor: pointer;
            border: 1px solid rgba(255,255,255,0.05);
        }
        .team-card:hover { background: rgba(255,255,255,0.1); }

        /* Rankings Fase de Grupos */
        .rank-1 { border-left: 4px solid var(--accent-gold) !important; background: linear-gradient(90deg, rgba(251,191,36,0.1), transparent); }
        .rank-2 { border-left: 4px solid var(--accent-silver) !important; background: linear-gradient(90deg, rgba(148,163,184,0.1), transparent); }
        .rank-3 { border-left: 4px solid var(--accent-bronze) !important; background: linear-gradient(90deg, rgba(205,127,50,0.1), transparent); }
        .rank-badge { width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold; color: black; margin-right: 8px; }

        /* --- Estilos del Bracket (Fase 3) --- */
        #bracket-container {
            display: flex;
            gap: 40px;
            padding: 20px;
            overflow-x: auto;
            min-height: 80vh;
            align-items: center; /* Centrar verticalmente */
        }
        
        .round-column {
            display: flex;
            flex-direction: column;
            justify-content: space-around;
            min-width: 240px;
            gap: 20px;
        }

        .match-card {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
        }

        .match-team {
            padding: 8px 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            transition: background 0.2s;
            height: 40px;
        }
        .match-team:last-child { border-bottom: none; }
        .match-team:hover { background: rgba(255,255,255,0.1); }
        
        .match-team.winner {
            background: linear-gradient(90deg, rgba(34, 197, 94, 0.2), transparent);
            font-weight: bold;
            color: #4ade80;
        }
        .match-team.loser { opacity: 0.4; }
        .match-team.empty { color: #64748b; font-style: italic; font-size: 12px; pointer-events: none; }

        .round-title { text-align: center; color: #94a3b8; text-transform: uppercase; font-size: 12px; font-weight: bold; letter-spacing: 2px; margin-bottom: 10px; position: sticky; top: 0; background: #020617; padding: 10px; z-index: 10; }

        /* Scrollbar personalizado para el bracket */
        #bracket-container::-webkit-scrollbar { height: 12px; }
        #bracket-container::-webkit-scrollbar-thumb { background: #475569; border-radius: 6px; }
        #bracket-container::-webkit-scrollbar-track { background: #0f172a; }

        /* Utilidades */
        .hidden-section { display: none !important; }
        .fade-in { animation: fadeIn 0.8s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Campe√≥n */
        .champion-card {
            transform: scale(1.2);
            border: 2px solid var(--accent-gold);
            box-shadow: 0 0 30px rgba(251, 191, 36, 0.5);
        }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <!-- Header Fijo -->
    <header class="h-16 flex-shrink-0 border-b border-white/10 bg-black/40 backdrop-blur-md flex items-center justify-between px-6 z-50">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 bg-gradient-to-br from-amber-400 to-amber-600 rounded-full flex items-center justify-center text-black font-bold text-xs">26</div>
            <h1 class="font-bold tracking-tight text-lg hidden md:block">SIMULADOR <span class="text-amber-400">MUNDIAL 2026</span></h1>
        </div>
        
        <div id="game-status" class="px-4 py-1 rounded-full bg-white/10 border border-white/20 text-xs font-bold uppercase tracking-wider text-amber-400">
            Inicio
        </div>

        <button onclick="location.reload()" class="text-xs text-gray-400 hover:text-white uppercase tracking-wider font-semibold border border-white/20 px-3 py-1 rounded-full hover:bg-white/10 transition">
            Reiniciar
        </button>
    </header>

    <!-- √Årea Principal -->
    <main class="flex-grow overflow-y-auto relative">
        
        <!-- SECCI√ìN 1: INTRO -->
        <section id="intro-section" class="min-h-full flex flex-col items-center justify-center text-center p-6 fade-in">
            <div class="mb-6 relative">
                <div class="absolute inset-0 bg-amber-500 blur-[80px] opacity-20 rounded-full"></div>
                <div class="relative text-7xl animate-bounce">‚öΩ</div>
            </div>
            <h2 class="text-4xl md:text-6xl font-black text-white mb-6 tracking-tight">
                Simul√° el <span class="text-amber-400">Mundial 2026</span>
            </h2>
            <p class="text-gray-400 text-lg mb-10 max-w-lg">
                Gener√° los grupos, elig√≠ a los clasificados y jug√° toda la fase eliminatoria hasta levantar la copa.
            </p>
            <button onclick="runOneShotDraw()" class="bg-white text-black px-10 py-4 rounded-full text-xl font-black uppercase tracking-widest hover:bg-amber-400 hover:scale-105 transition shadow-lg">
                Comenzar Sorteo
            </button>
        </section>

        <!-- SECCI√ìN 2: GRUPOS (Scroll vertical) -->
        <section id="draw-section" class="hidden-section p-6 min-h-full">
            <div id="groups-header" class="text-center mb-8">
                <h2 class="text-3xl font-bold text-white">Fase de Grupos</h2>
                <p class="text-gray-400 text-sm mt-2">Hac√© clic para ordenar: <span class="text-amber-400">1¬∫ de cada grupo</span>, <span class="text-gray-300">2¬∫ de cada grupo</span>. <span id="phase2-hint" class="hidden text-orange-400">Luego elige 8 terceros.</span></p>
            </div>
            <div id="groups-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 pb-20">
                <!-- Grupos JS -->
            </div>
        </section>

        <!-- SECCI√ìN 3: BRACKET (Scroll horizontal) -->
        <section id="bracket-section" class="hidden-section h-full w-full bg-[#0f172a]">
            <div id="bracket-container">
                <!-- Columnas del Bracket inyectadas por JS -->
            </div>
        </section>

    </main>

    <!-- MODAL -->
    <div id="modal-overlay" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[100] hidden flex items-center justify-center opacity-0 transition-opacity duration-300">
        <div class="bg-[#1e293b] p-8 rounded-2xl border border-white/10 shadow-2xl max-w-md text-center transform scale-95 transition-all">
            <div class="text-4xl mb-4">üèÜ</div>
            <h3 id="modal-title" class="text-2xl font-bold text-white mb-2">T√≠tulo</h3>
            <p id="modal-msg" class="text-gray-300 mb-6">Mensaje</p>
            <button id="modal-btn" class="px-8 py-3 bg-amber-500 text-black font-bold rounded-full hover:bg-amber-400 transition shadow-lg">Continuar</button>
        </div>
    </div>

    <script>
        // --- DATOS ---
        const potsData = [
            [ { name: "Estados Unidos", code: "us" }, { name: "M√©xico", code: "mx" }, { name: "Canad√°", code: "ca" }, { name: "Argentina", code: "ar" }, { name: "Brasil", code: "br" }, { name: "Inglaterra", code: "gb-eng" }, { name: "Francia", code: "fr" }, { name: "Portugal", code: "pt" }, { name: "Pa√≠ses Bajos", code: "nl" }, { name: "Alemania", code: "de" }, { name: "B√©lgica", code: "be" }, { name: "Espa√±a", code: "es" } ],
            [ { name: "Croacia", code: "hr" }, { name: "Marruecos", code: "ma" }, { name: "Colombia", code: "co" }, { name: "Uruguay", code: "uy" }, { name: "Senegal", code: "sn" }, { name: "Suiza", code: "ch" }, { name: "Jap√≥n", code: "jp" }, { name: "Ir√°n", code: "ir" }, { name: "Corea del Sur", code: "kr" }, { name: "Ecuador", code: "ec" }, { name: "Austria", code: "at" }, { name: "Australia", code: "au" } ],
            [ { name: "Noruega", code: "no" }, { name: "Panam√°", code: "pa" }, { name: "Egipto", code: "eg" }, { name: "Argelia", code: "dz" }, { name: "Escocia", code: "gb-sct" }, { name: "Paraguay", code: "py" }, { name: "T√∫nez", code: "tn" }, { name: "Costa de Marfil", code: "ci" }, { name: "Uzbekist√°n", code: "uz" }, { name: "Qatar", code: "qa" }, { name: "Arabia Saudita", code: "sa" }, { name: "Sud√°frica", code: "za" } ],
            [ { name: "Jordania", code: "jo" }, { name: "Cabo Verde", code: "cv" }, { name: "Ghana", code: "gh" }, { name: "Curazao", code: "cw" }, { name: "Hait√≠", code: "ht" }, { name: "Nueva Zelanda", code: "nz" }, { name: "Repechaje EU", code: "eu" }, { name: "Repechaje EU", code: "eu" }, { name: "Repechaje EU", code: "eu" }, { name: "Repechaje EU", code: "eu" }, { name: "Rep. Inter", code: "un" }, { name: "Rep. Inter", code: "un" } ]
        ];

        const groupLetters = ["A", "B", "C", "D", "E", "F", "G", "H", "I", "J", "K", "L"];
        
        // Estado Global
        let groupsState = [];
        let currentPhase = 1; // 1=Grupos(1/2), 2=Grupos(3ros), 3=Bracket
        let bestThirdsCount = 0;
        const MAX_THIRDS = 8;

        // Estructura de Partidos (Base vac√≠a)
        let matches = {}; 

        // --- INICIO ---
        function runOneShotDraw() {
            // Inicializar Grupos
            groupsState = groupLetters.map(letter => ({ id: letter, teams: [], selectionStep: 0 }));
            potsData.forEach(pot => {
                const shuffled = [...pot].sort(() => Math.random() - 0.5);
                shuffled.forEach((team, i) => groupsState[i].teams.push({ ...team, status: 0 }));
            });

            // Cambiar Vista
            document.getElementById('intro-section').classList.add('hidden-section');
            document.getElementById('draw-section').classList.remove('hidden-section');
            document.getElementById('game-status').innerText = "Fase de Grupos";
            
            renderAllGroups();
        }

        // --- L√ìGICA FASE DE GRUPOS ---
        function renderAllGroups() {
            const grid = document.getElementById('groups-grid');
            grid.innerHTML = '';
            groupsState.forEach((g, i) => grid.appendChild(createGroupCard(g, i)));
        }

        function createGroupCard(group, groupIndex) {
            const div = document.createElement('div');
            div.className = "glass-panel rounded-xl p-3 flex flex-col gap-2 shadow-lg";
            
            // Header
            let headerClass = "text-white";
            if(group.selectionStep === 2) headerClass = "text-green-400";
            if(currentPhase === 2 && group.teams.some(t=>t.status===3)) headerClass = "text-orange-400";

            div.innerHTML = `<div class="flex justify-between items-center mb-1 border-b border-white/10 pb-2">
                <span class="font-black ${headerClass}">GRUPO ${group.id}</span>
                <span class="text-[10px] uppercase text-gray-500">${getGroupStatusText(group)}</span>
            </div>`;

            // Teams
            group.teams.forEach((team, idx) => {
                const flag = getFlag(team.code);
                let style = "opacity-70 grayscale";
                let badge = "";
                
                if(team.status === 1) { style = "rank-1 opacity-100"; badge = `<div class="rank-badge bg-amber-400">1</div>`; }
                else if(team.status === 2) { style = "rank-2 opacity-100"; badge = `<div class="rank-badge bg-slate-400">2</div>`; }
                else if(team.status === 3) { style = "rank-3 opacity-100"; badge = `<div class="rank-badge bg-orange-600 text-white">3</div>`; }
                else if(currentPhase === 1 && group.selectionStep === 2) style = "opacity-30"; 

                const row = document.createElement('div');
                row.className = `team-card ${style} p-2 rounded flex items-center gap-2 select-none`;
                row.innerHTML = `${badge}<img src="${flag}" class="w-5 h-3 object-cover rounded shadow">${team.name}`;
                row.onclick = () => handleGroupClick(groupIndex, idx);
                div.appendChild(row);
            });
            return div;
        }

        function getGroupStatusText(g) {
            if(currentPhase === 1) return g.selectionStep === 2 ? "Listo" : "Elegir 1¬∫/2¬∫";
            if(currentPhase === 2) return g.teams.some(t=>t.status===3) ? "3¬∫ Listo" : "Elegir 3¬∫ (Opc)";
            return "";
        }

        function handleGroupClick(gIdx, tIdx) {
            const group = groupsState[gIdx];
            const team = group.teams[tIdx];

            if(currentPhase === 1) {
                if(group.selectionStep === 2) { resetGroup(gIdx); return; }
                if(team.status !== 0) return;

                team.status = group.selectionStep === 0 ? 1 : 2;
                group.selectionStep++;
                
                // Ordenar visualmente
                group.teams.sort((a,b) => (a.status===0?9:a.status) - (b.status===0?9:b.status));
                renderAllGroups();

                if(groupsState.every(g => g.selectionStep === 2)) {
                    showModal("Ahora elig√≠ los 8 mejores terceros de la primera ronda.", startPhase2);
                }
            } else if (currentPhase === 2) {
                if(team.status === 1 || team.status === 2) return;
                
                if(team.status === 3) { team.status = 0; bestThirdsCount--; }
                else {
                    if(bestThirdsCount >= MAX_THIRDS) { alert("Solo 8 terceros"); return; }
                    // Quitar otro tercero del mismo grupo si existe
                    const old = group.teams.find(t=>t.status===3);
                    if(old) { old.status=0; bestThirdsCount--; }
                    team.status = 3; bestThirdsCount++;
                }
                group.teams.sort((a,b) => (a.status===0?9:a.status) - (b.status===0?9:b.status));
                renderAllGroups();
                
                if(bestThirdsCount === MAX_THIRDS) {
                    setTimeout(() => showModal("¬°Fase de Grupos Terminada!", "Generando llave de eliminatorias...", startBracketPhase), 500);
                }
            }
        }

        function resetGroup(idx) {
            groupsState[idx].teams.forEach(t => t.status=0);
            groupsState[idx].selectionStep=0;
            renderAllGroups();
        }

        function startPhase2() {
            currentPhase = 2;
            document.getElementById('phase2-hint').classList.remove('hidden');
            document.getElementById('game-status').innerText = "Eligiendo Terceros";
            renderAllGroups();
        }

        // --- L√ìGICA FASE 3: BRACKET ---
        
        function startBracketPhase() {
            currentPhase = 3;
            document.getElementById('draw-section').classList.add('hidden-section');
            const bracketSection = document.getElementById('bracket-section');
            bracketSection.classList.remove('hidden-section');
            document.getElementById('game-status').innerText = "Eliminatorias";
            
            generateBracketData();
            renderBracket();
        }

        function getTeam(groupId, rank) {
            // groupId: 'A', 'B'... rank: 1, 2, 3
            const group = groupsState.find(g => g.id === groupId);
            return group.teams.find(t => t.status === rank);
        }

        function generateBracketData() {
            // 1. Identificar a los terceros clasificados y sus grupos
            const thirdPlaceGroups = groupsState
                .filter(g => g.teams.some(t => t.status === 3))
                .map(g => g.id); // Ej: ['A', 'C', 'D', ...]

            // 2. Funci√≥n auxiliar para asignar terceros
            // Toma una lista de opciones (Ej: 'A,B,C'), busca cu√°l est√° disponible y la asigna
            const assignedThirds = new Set();
            function getThird(optionsArray) {
                for (let letter of optionsArray) {
                    if (thirdPlaceGroups.includes(letter) && !assignedThirds.has(letter)) {
                        assignedThirds.add(letter);
                        return getTeam(letter, 3);
                    }
                }
                // Fallback por si la combinaci√≥n es rara (agarra cualquiera disponible)
                for (let letter of thirdPlaceGroups) {
                    if (!assignedThirds.has(letter)) {
                        assignedThirds.add(letter);
                        return getTeam(letter, 3);
                    }
                }
                return { name: "TBD", code: "un" };
            }

            // 3. Definir Partidos (Round of 32)
            // ID: numero de partido. Next: a donde va el ganador. Slot: 0 (arriba) o 1 (abajo) en el siguiente partido.
            
            // DIECISEISAVOS (R32)
            const r32 = [
                { id: 73, t1: getTeam('A', 2), t2: getTeam('B', 2), next: 90, slot: 0 },
                { id: 74, t1: getTeam('E', 1), t2: getThird(['A','B','C','D','F']), next: 89, slot: 0 },
                { id: 75, t1: getTeam('F', 1), t2: getTeam('C', 2), next: 90, slot: 1 },
                { id: 76, t1: getTeam('C', 1), t2: getTeam('F', 2), next: 91, slot: 0 }, // Corregido: 1C vs 2F
                { id: 77, t1: getTeam('I', 1), t2: getThird(['C','D','F','G','H']), next: 89, slot: 1 },
                { id: 78, t1: getTeam('E', 2), t2: getTeam('I', 2), next: 91, slot: 1 },
                { id: 79, t1: getTeam('A', 1), t2: getThird(['C','E','F','H','I']), next: 92, slot: 0 },
                { id: 80, t1: getTeam('L', 1), t2: getThird(['E','H','I','J','K']), next: 92, slot: 1 },
                { id: 81, t1: getTeam('D', 1), t2: getThird(['B','E','F','I','J']), next: 94, slot: 0 },
                { id: 82, t1: getTeam('G', 1), t2: getThird(['A','E','H','I','J']), next: 94, slot: 1 },
                { id: 83, t1: getTeam('K', 2), t2: getTeam('L', 2), next: 93, slot: 0 },
                { id: 84, t1: getTeam('H', 1), t2: getTeam('J', 2), next: 93, slot: 1 },
                { id: 85, t1: getTeam('B', 1), t2: getThird(['E','F','G','I','J']), next: 96, slot: 0 },
                { id: 86, t1: getTeam('J', 1), t2: getTeam('H', 2), next: 95, slot: 0 },
                { id: 87, t1: getTeam('K', 1), t2: getThird(['D','E','I','J','L']), next: 96, slot: 1 },
                { id: 88, t1: getTeam('D', 2), t2: getTeam('G', 2), next: 95, slot: 1 }
            ];

            // Inicializar estado de partidos en objeto matches
            r32.forEach(m => matches[m.id] = createMatchObj(m));

            // Crear huecos vac√≠os para las siguientes rondas
            // OCTAVOS
            [89, 90, 91, 92, 93, 94, 95, 96].forEach(id => matches[id] = createMatchObj({ id, next: getNextForR16(id), slot: id % 2 === 1 ? 0 : 1 }));
            // CUARTOS
            [97, 98, 99, 100].forEach(id => matches[id] = createMatchObj({ id, next: getNextForQF(id), slot: id % 2 === 1 ? 0 : 1 }));
            // SEMIS
            matches[101] = createMatchObj({ id: 101, next: 104, slot: 0, loserNext: 103, loserSlot: 0 });
            matches[102] = createMatchObj({ id: 102, next: 104, slot: 1, loserNext: 103, loserSlot: 1 });
            // TERCER PUESTO
            matches[103] = createMatchObj({ id: 103, next: null });
            // FINAL
            matches[104] = createMatchObj({ id: 104, next: null });
        }

        function createMatchObj(data) {
            return {
                id: data.id,
                p1: data.t1 || null,
                p2: data.t2 || null,
                winner: null,
                nextMatchId: data.next,
                nextMatchSlot: data.slot,
                loserNext: data.loserNext || null,
                loserSlot: data.loserSlot || 0
            };
        }

        // Helpers para conectar las llaves manualmente seg√∫n el esquema
        function getNextForR16(id) {
            if(id==89||id==90) return 97;
            if(id==91||id==92) return 99;
            if(id==93||id==94) return 98;
            if(id==95||id==96) return 100;
        }
        function getNextForQF(id) {
            if(id==97||id==98) return 101;
            if(id==99||id==100) return 102;
        }

        // --- RENDERIZADO DEL BRACKET ---
        function renderBracket() {
            const container = document.getElementById('bracket-container');
            container.innerHTML = '';

            // Definir Columnas
            const rounds = [
                { name: "16avos", ids: [74,77,73,75,76,78,79,80,83,84,81,82,86,88,85,87] }, // Orden visual para que coincidan las llaves
                { name: "Octavos", ids: [89, 90, 91, 92, 93, 94, 95, 96] },
                { name: "Cuartos", ids: [97, 99, 98, 100] },
                { name: "Semis", ids: [101, 102] },
                { name: "Finales", ids: [104, 103] } // Final arriba, 3ro abajo
            ];

            rounds.forEach(round => {
                const col = document.createElement('div');
                col.className = "round-column";
                
                const title = document.createElement('div');
                title.className = "round-title";
                title.innerText = round.name;
                col.appendChild(title);

                round.ids.forEach(matchId => {
                    col.appendChild(createMatchCard(matches[matchId]));
                });

                container.appendChild(col);
            });
        }

        function createMatchCard(match) {
            const card = document.createElement('div');
            card.className = "match-card";
            if (match.id === 104) card.classList.add("border-amber-400", "border-2"); // Highlight Final
            if (match.id === 103) card.classList.add("opacity-80"); // 3rd place

            // Equipo 1
            const div1 = document.createElement('div');
            div1.className = `match-team ${match.winner === match.p1 && match.winner ? 'winner' : ''} ${match.winner && match.winner !== match.p1 ? 'loser' : ''}`;
            if (!match.p1) {
                div1.classList.add('empty');
                div1.innerText = "Esperando...";
            } else {
                div1.innerHTML = `<img src="${getFlag(match.p1.code)}" class="w-5 h-3">${match.p1.name}`;
                div1.onclick = () => advanceTeam(match.id, match.p1);
            }

            // Equipo 2
            const div2 = document.createElement('div');
            div2.className = `match-team ${match.winner === match.p2 && match.winner ? 'winner' : ''} ${match.winner && match.winner !== match.p2 ? 'loser' : ''}`;
            if (!match.p2) {
                div2.classList.add('empty');
                div2.innerText = "Esperando...";
            } else {
                div2.innerHTML = `<img src="${getFlag(match.p2.code)}" class="w-5 h-3">${match.p2.name}`;
                div2.onclick = () => advanceTeam(match.id, match.p2);
            }

            // Info Partido
            const info = document.createElement('div');
            info.className = "text-[9px] text-gray-600 text-center bg-black/20 py-1";
            info.innerText = match.id === 104 ? "FINAL" : (match.id === 103 ? "3er Puesto" : `#${match.id}`);

            card.appendChild(div1);
            card.appendChild(div2);
            card.appendChild(info);
            return card;
        }

        function advanceTeam(matchId, winnerTeam) {
            const match = matches[matchId];
            if (match.winner) return; // Ya se jug√≥

            match.winner = winnerTeam;
            const loserTeam = winnerTeam === match.p1 ? match.p2 : match.p1;

            // Avanzar Ganador
            if (match.nextMatchId) {
                const nextMatch = matches[match.nextMatchId];
                if (match.nextMatchSlot === 0) nextMatch.p1 = winnerTeam;
                else nextMatch.p2 = winnerTeam;
            }

            // Caso Semifinales: Perdedor va al 3er puesto
            if (match.loserNext && loserTeam) {
                const loserMatch = matches[match.loserNext];
                if (match.loserSlot === 0) loserMatch.p1 = loserTeam;
                else loserMatch.p2 = loserTeam;
            }

            // Si es la final
            if (match.id === 104) {
                launchConfetti();
                showModal("¬°CAMPE√ìN!", `üèÜ ${winnerTeam.name} ha ganado el Mundial 2026`, null);
            }

            renderBracket();
        }

        // --- UTILS ---
        function getFlag(code) {
            if(code==='un'||code==='eu') return 'https://upload.wikimedia.org/wikipedia/commons/thumb/a/a9/FIFA_Flag.svg/1200px-FIFA_Flag.svg.png';
            return `https://flagcdn.com/w40/${code}.png`;
        }

        function showModal(title, msg, callback) {
            const overlay = document.getElementById('modal-overlay');
            const overlayClasses = ["hidden", "opacity-0"];
            overlay.classList.remove(...overlayClasses);
            overlay.classList.add("flex"); // make visible immediately for layout
            setTimeout(() => overlay.classList.add("opacity-100"), 10); // fade in

            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-msg').innerText = msg;
            
            const btn = document.getElementById('modal-btn');
            btn.onclick = () => {
                overlay.classList.remove("opacity-100");
                setTimeout(() => overlay.classList.add("hidden"), 300);
                if(callback) callback();
            };
        }

        function launchConfetti() {
            const colors = ['#fbbf24', '#ffffff', '#ef4444', '#22c55e'];
            for(let i=0; i<100; i++) {
                const c = document.createElement('div');
                c.style.cssText = `position:fixed; left:${Math.random()*100}vw; top:-10px; width:10px; height:10px; background:${colors[Math.floor(Math.random()*4)]}; z-index:999; transition:1s; pointer-events:none;`;
                document.body.appendChild(c);
                c.animate([
                    { transform: `translateY(0) rotate(0deg)` },
                    { transform: `translateY(100vh) rotate(720deg)` }
                ], { duration: Math.random()*2000+2000, fill: 'forwards' });
            }
        }
    </script>
</body>
</html>
